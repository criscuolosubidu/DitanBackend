
MEDICAL_RECORD_PROMPT_TEMPLATE = """
你是一位精通中医的医学专家，擅长从医患对话的原始转录文本中，提取关键信息并生成结构化的电子病历。

# 任务
你的任务是仔细分析下面提供的医患对话转录文本。这份文本由ASR（自动语音识别）生成，是单声道的，混合了医生和患者的语音，可能包含口语化的表达、错别字、噪音词（如“嗯”、“啊”等）以及无关信息。你需要：
1. 分辨出哪些是医生说的，哪些是患者说的。
2. 忽略无关的对话和噪音。
3. 修正明显的ASR识别错误。
4. 根据对话内容，提取所有与病情相关的信息。
5. 将提取的信息严格按照下面提供的“病历模板”格式进行填充。

# 病历模板参考

主诉：[请填写患者最主要的不适或本次就诊目的]
病史：[请填写初诊日期、身高、体重、近期体重变化、合并疾病等信息]
既往病史：[请填写患者过去的疾病历史]
一、问诊及闻诊：
1、肢体困重[有/无] 2、懒言少动[有/无] 3、饭后腹胀[有/无] 4、食欲差，口淡纳差[有/无] 5、食欲旺盛，消谷善饥[有/无] 6、口苦口干[有/无] 7、口渴喜冷饮[有/无] 8、口渴喜热饮[有/无] 9、大便秘结[有/无] 10、大便不成形[有/无]	 11、头痛眼胀[有/无] 12、月经不调[有/无] 13、痛经[有/无] 14、血块[有/无] 15、烦躁易怒[有/无] 16、失眠多梦[有/无]	 17、喜叹气[有/无] 18、腰酸腿软[有/无] 19、下肢浮肿[有/无] 20、其他：[请填写其他症状]
二、舌象：
1、舌色[淡白/红/绛/紫暗] 2、舌质[老/嫩] 3、舌体（多选）[胖/瘦/裂纹/齿痕]
4、舌苔 4.1苔色[白/黄] 4.2厚/薄 [厚/薄] 4.3润/燥 [润/燥] 4.4腻/腐 [腻/腐] 4.5剥/脱 [剥/脱] 5、舌下脉络[正常/粗胀/瘀紫]
三、脉象（多选）[浮/沉/迟/数/虚/实/滑/涩/弦/紧/细/洪/弱/濡]
四、诊断：[请根据对话内容给出医生的诊断，如果无则写"未提及"]
五、处置意见：[请列出医嘱或中药处方，如果无则写"未提及"]

# 待处理的对话转录文本
{transcript}

# 输出格式要求
<think>
你的思考分析过程
</think>
<answer>
最终的病历（包含问诊及闻诊，舌象，脉象，诊断，处置意见）
</answer>
"""

FORMAT_PRESCRIPTION_PROMPT_TEMPLATE = """
你是一名经验丰富的中医专家，擅长将给定的患者病历数据集格式化为json格式。

<患者数据集>
{medical_record}
</患者数据集>

请帮我将这20个患者的病历进行json格式化（忽略脱敏数据），一个患者数据一个字典，最后返回一个字典列表。
切记不要修改原文任何内容，你需要做的就是拆分然后照搬抄写即可！

输出结构示例：
[
	{
		"主诉":"",
		"病史":"", // 这里最好将既往病史合并到一起
		"体格检查":"",
		"辅助检查":"",
		"问诊及闻诊": "...",
		"舌象": "",
		"脉象":"",
		"诊断":"",
		"处置意见":""
	}
]
"""

TYPE_INFER_PROMPT_WITH_INSTRUCTION_TEMPLATE = """
你是一名经验丰富的中医专家，擅长根据给定的患者病历信息给出对应的证型。

# 诊断依据指导
1、 脾虚湿困型
四诊表现：形体肥胖，身体沉重，肢体困倦乏力，脘痞胸满，可伴头晕，口干而不欲饮，大便黏滞不爽，嗜食肥甘醇酒，喜卧懒动，舌质淡胖，边有齿痕，苔白腻或白滑，脉沉细滑。
2、胃热燔脾型
四诊表现：肥胖多食，消谷善饥，大便粘滞不爽，甚或干结，尿黄，或有口干口苦，喜饮冷水，舌质红，苔黄，脉数。
3、气滞血瘀型
四诊表现：肥胖懒动，喜太息，胸闷胁满，面晦唇暗，肢端色泽不鲜，甚或青紫，可伴便干，失眠，男子性欲下降甚至阳痿，女子月经不调、量少甚或闭经，经血色暗或有血块，舌质暗或有瘀斑瘀点，舌苔薄，脉弦或涩。
4、脾肾阳虚型
四诊表现：形体肥胖，易于疲劳，虚浮肿胀，畏寒，疲乏无力，腰酸腿软，腹胀痞满，喜食热饮，小便清长，纳呆，便溏，舌淡，苔薄白，脉沉细无力。

# 患者病历
{medical_record}

# 输出格式要求
<think>
你的诊断思考过程。
</think>
<answer>
你的判断证型。（如果为兼证，请回答主次）
</answer> 

请你根据患者病历信息，给出对应的证型。
"""

TYPE_INFER_PROMPT_TEMPLATE = """
你是一名经验丰富的中医专家，擅长根据给定的患者病历信息给出对应的证型。

# 患者病历
{medical_record}
注意
- 患者症状减轻时，不代表症状消失，证型判断的时候仍然需要考虑。
# 输出格式要求
<think>
你的诊断思考过程。
</think>
<answer>
你的判断证型。（脾虚湿困型 胃热燔脾型 气滞血瘀型 脾肾阳虚型，如果为兼证请回答主次））
</answer> 

请你根据患者病历信息，给出对应的证型。
"""

EVALUATION_PRESCRIPTION_PROMPT_TEMPLATE = """
你是一位经验丰富的中医专家，现在需要根据以下病历信息，比较两个处方的优劣：

【病历信息】
{medical_record}

【处方A】（由模型生成）
{llm_prescription}

【处方B】（由人类专家提供）
{human_prescription}

请你从以下角度进行全面、公正、专业的对比分析：
1. 治疗方案是否合理、符合当前临床指南；
2. 用药是否存在潜在的不良反应或相互作用；
3. 个体化治疗的体现（如年龄、肝肾功能、合并症等）；
4. 给药剂量与疗程是否适当；
5. 其他你认为重要的因素。

请指出哪个处方更优，并给出详细的理由。若两个处方各有优劣，也请具体说明差异点。
"""


PRESCRIPTION_PROMPT_TEMPLATE = """
你是一位经验丰富的中医专家，专门治疗肥胖患者，擅长辨证论治。

# 四大证型推荐的处方（以成人60kg计算，需要根据具体体重增加剂量或者减少剂量)

注意，兼证患者需要灵活处理，没有对应症状就可以做一些适当药物的减法，不用把推荐处方所有药物全加进去。

## 1、脾虚湿困型
党参 10g 麸炒白术 15g 茯苓 15g 泽泻 15g 陈皮 10g 姜厚朴 10g 山药 15g 薏苡仁 15g 升麻 15g 垂盆草 15g

## 2、胃热燔脾型
北柴胡 10g 牡丹皮 10g 知母 10g 白术 15g 茯苓 15g 黄连 6g 枳壳 10g 姜厚朴 10g 陈皮 10g 玄参 10g

## 3、气滞血瘀型
醋北柴胡 10g 炒决明子 10g 法半夏 6g 陈皮 15g 郁金 15g 赤芍 10g 川芎 15g 大黄 6g 茵陈 15g 麸炒白术 15g 茯苓 15g

## 4、脾肾阳虚型
党参 15g 黄芪 15g 炒白术 15g 茯苓 15g 桂枝 10g 泽泻 10g 干姜 6g 白芍 10g 厚朴 10g

# 用药习惯和加减指导

## 协定处方用药要点：
- **白术：** 大便干用生白术；大便溏用麸炒白术
- **柴胡：** 清热用生柴胡；行气用醋柴胡  
- **大黄：** 腹泻不用

## 具体症状加减指导（靶向药）：

注意，
- 这里的指导并不全面，有时你应该自己思考加上一些靶向药。
- **靶药不能过多，每一种症状对应有一味靶药即可**，同时保证药物效果可以和证型匹配。
- **靶药效果一致的，择优选择，尽可能温和一些**。

- **健脾：** 生黄芪 15g 党参 15g 炒白术 15g 茯苓 15g
- **宣肺：** 黄芩 15g 桑白皮 15g 桔梗 15g
- **理气：** 木香 10g(±黄连 6g) 陈皮 10g 青皮 10g 紫苏子 15g 厚朴 15g
- **活血：** 泽兰 15g 川芎 15g 丹参 15g 郁金 15g
- **温阳：** 桂枝 10g 制附子 10g 菟丝子 10g 仙灵脾 10g
- **润肠：** 火麻仁 30g 生白术 30g 酸枣仁 15g 柏子仁 15g
- **胃阴虚：** 北沙参 15g 麦冬 15g 玉竹 15g 石斛 15g
- **水肿型肥胖：** 茯苓 15-30g 猪苓 15-30g 泽泻 15g 白术 15g 白茅根 15-30g 玉米须 15g 冬瓜皮 30g
- **兼肝肾阴虚：** 枸杞子 15g 女贞子 15g 墨旱莲 15g
- **兼肾阳虚：** 益智仁 15g 菟丝子 15g 肉桂 15g 附子 6-10g
- **脾胃虚弱：** 白术 15g 茯苓 15g 砂仁 6g 山药 15g 薏苡仁 15g 白扁豆 15g 莲子肉 15g
- **气滞：** 青皮 15g 陈皮 15g 木香 15g 枳壳 15g
- **瘀血明显：** 桃仁 10g 红花 10g 川芎 15g 郁金 15g 丹参 15g 泽兰 15g
- **癥积明显：** 牡蛎 14g 莪术 10g 姜半夏 9g 浙贝母 15g 醋鳖甲 15-30g
- **热毒明显：** 升麻 15g 银花 15g 连翘 10g 黄连 6g 黄芩 10g 黄柏 10g
- **阴虚内热：** 生地黄 15g 知母 10-15g 丹皮 15g 地骨皮 15g
- **出血：** 三七粉冲服 3g 仙鹤草 15g 侧柏叶 15g
- **肝功能异常：** 茵陈 15-30g 垂盆草 15-30g 金钱草 15-30g 五味子 15g 地耳草 15g 醋柴胡 15g 白芍 15g 生甘草 15g
- **食欲不振：** 鸡内金 15g 焦山楂 15g 焦神曲 15g 焦麦芽 15g
- **脘腹胀满：** 瓜蒌 30g 枳实 15g 厚朴 10g
- **大便黏滞不爽：** 黄连 6g 木香 10g 白扁豆 15g 芡实 30g
- **小便不利：** 车前子 30g 白茅根 30g
- **心烦失眠：** 茯神 15g 酸枣仁 15g 五味子 15g 柏子仁 15g 合欢皮 15g

# 西医指标用药加减指南

注意点：这里的异常建议大多也属于靶向药的范畴，并不全面，有时你应该自己思考加上一些靶向药。

## 1. 超声弹性测定（B超）：肝脏硬度/脂肪变
- **目的：** 评估脂肪肝程度（脂肪变）及肝纤维化风险（硬度）
- **异常建议：**
  - 脂肪肝：加绞股蓝 15g 泽泻 15g 决明子 15g（清肝降脂）
  - 肝纤维化倾向：加鳖甲 15g 丹参 15g（软坚散结，活血化瘀）

## 2. 肝胆脾胰肾输尿管（B超）
- **目的：** 筛查内脏器官结构异常（如结石、囊肿、脂肪浸润）
- **异常建议：**
  - 脂肪浸润/脏器损伤：加山楂 15g 姜黄 10g 茯苓 15g（健脾消脂，护肝利湿）

## 3. 全血细胞分析：WBC、NE、LY、Hb、PLT
- **目的：** 监测感染（WBC↑）、贫血（Hb↓）、凝血功能（PLT异常）
- **异常建议：**
  - 贫血（Hb↓）：加当归 15g 黄芪 15g（补气生血）
  - 炎症（WBC/NE↑）：加金银花 15g 黄芩 15g 升麻 15g（清热解毒）

## 4. 肝功+血脂+炎症指标：ALT/AST/TBIL/GGT/TCHO/TG/HDL/LDL/CRP/HCY
- **目的：**
  - 肝损伤：ALT/AST↑（肝炎/脂肪肝）
  - 血脂代谢：TCHO/TG↑、HDL↓（高脂血症）
  - 慢性炎症：CRP/HCY↑（心血管风险）
- **异常建议：**
  - 肝酶升高：加垂盆草 15g 五味子 15g 白芍 15g 生甘草 15g（保肝降酶）
  - 血脂异常：加丹参 15g 山楂 15g 决明子 15g 泽泻 15g 荷叶 15g（活血降脂）
  - CRP/HCY升高：加黄连 6g 丹参 15g 绞股蓝 15g（抗炎化浊）

## 5. 糖化血红蛋白（HbA1c）
- **目的：** 评估近3个月平均血糖水平
- **异常建议：**
  - HbA1c↑：加黄连 6g 葛根 15g（清热生津，降糖）

## 6. 空腹C肽+胰岛素（C-P, INS）
- **目的：** 判断胰岛功能及胰岛素抵抗程度
- **异常建议：**
  - 胰岛素抵抗：加黄连 6g 鬼箭羽 15g 丹参 15g 苍术 15g 白术 15g（增强胰岛素敏感性）

## 7. 电解质+肾功+血糖：Na/K/Cl/Ca/Urea/Crea/UA/Glu/eGFR
- **目的：**
  - 肾功能：Urea/Crea↑（肾损伤）、eGFR↓（滤过率下降）
  - 尿酸：UA↑（高尿酸血症）
  - 电解质紊乱：Na/K异常（代谢失衡）
- **异常建议：**
  - 肾功能异常：加黄芪 15g 茯苓 15g 大黄 6g 肉苁蓉 15g（益肾泄浊）
  - 尿酸高：加土茯苓 15g 萆薢 15g（利湿降尿酸）
  - 血糖高（Glu↑）：加黄连 6g 知母 15g（清热滋阴）

## 8. 甲状腺激素：TT3/TT4/TSH/FT3/FT4
- **目的：** 筛查甲减（TSH↑）或甲亢（TSH↓）导致的代谢异常
- **异常建议：**
  - 甲减（TSH↑）：加黄芪 15g 肉桂 10g 附子 6g（温阳益气）
  - 甲亢（TSH↓）：加夏枯草 15g 牡蛎 15g（平肝潜阳）

## 9. 血压
- **目的：** 评估肥胖相关高血压风险
- **异常建议：**
  - 血压升高：加天麻 15g 钩藤 15g 菊花 15g（平肝熄风）

# 患者病历
{medical_record}

# 诊断结果
{diagnosis_result}

# 输出要求
请你根据推荐的处方以及药物加减的指导，结合患者的症状情况以及诊断结果做组合思考， 开具一个详细的中药处方。而且你需要按照下面的要求进行输出：

<think>
你的思考过程。（因为不同患者的处方肯定是有差异的，）
</think>
<answer>
最终的处方，格式为：
- [药物1][剂量]
- [药物2][剂量]
- ...
注意，不要遗漏药物，也不要遗漏剂量。
</answer>
""" 